import os
from .. import loader, utils
from telethon.tl.functions.photos import GetUserPhotosRequest
from telethon.tl.functions.users import GetFullUserRequest

@loader.tds
class WhoIsMod(loader.Module):
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ."""
    strings = {'name': 'WhoIs'}

    async def whoiscmd(self, message):
        """–ò—Å–ø–æ–ª—å–∑—É–π .whois <@ –∏–ª–∏ —Ä–µ–ø–ª–∞–π>; –Ω–∏—á–µ–≥–æ"""
        args = utils.get_args_raw(message)
        reply = await message.get_reply_message()

        await message.edit("<b>–ü–æ–ª—É—á–∞—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ...</b>")

        try:
            if args:
                user = await message.client.get_entity(args if not args.isgidit() else int(args))
            else:
                user = await message.client.get_entity(reply.sender_id)
        except:
            user = await message.client.get_me()
        
        user = await message.client(GetFullUserRequest(user.id))
        photo, caption = await get_info(user, message)

        # Add premium stickers or any other custom content to the caption here
        premium_stickers = "üÖ∞Ô∏èüÖ∞Ô∏èüÖ∞Ô∏è"  # Replace with your premium stickers
        caption += f"\n<b>Premium Stickers:</b> {premium_stickers}"

        await message.client.send_file(message.chat_id, photo, caption=caption,
                                       link_preview=False, reply_to=reply.id if reply else None)
        os.remove(photo)
        await message.delete()


async def get_info(user, message):
    """–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ."""
    uuser = user.user

    user_photos = await message.client(GetUserPhotosRequest(user_id=uuser.id,
                                                           offset=42, max_id=0, limit=100))
    user_photos_count = "–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–≤–∞—Ç–∞—Ä–∫–∏."
    try:
        user_photos_count = user_photos.count
    except:
        pass

    user_id = uuser.id
    first_name = uuser.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–ª –∏–º—è."
    last_name = uuser.last_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–ª —Ñ–∞–º–∏–ª–∏—é."
    username = "@" + uuser.username or "–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —é–∑–µ—Ä–Ω–µ–π–º–∞."
    user_bio = user.about or "–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ–±–µ."
    common_chat = user.common_chats_count
    is_bot = "–î–∞" if uuser.bot else "–ù–µ—Ç"
    restricted = "–î–∞" if uuser.restricted else "–ù–µ—Ç"
    verified = "–î–∞" if uuser.verified else "–ù–µ—Ç"

    photo = await message.client.download_profile_photo(user_id, str(user_id) + ".jpg", download_big=True)

    # Add premium stickers or any other custom content to the caption here
    premium_stickers = "üÖ∞Ô∏èüÖ∞Ô∏èüÖ∞Ô∏è"  # Replace with your premium stickers
    caption = (f"<b>–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï:</b>\n\n"
               f"<b>–ò–º—è:</b> {first_name}\n"
               f"<b>–§–∞–º–∏–ª–∏—è:</b> {last_name}\n"
               f"<b>–Æ–∑–µ—Ä–Ω–µ–π–º:</b> {username}\n"
               f"<b>ID:</b> <code>{user_id}</code>\n"
               f"<b>–ë–æ—Ç:</b> {is_bot}\n"
               f"<b>–û–≥—Ä–∞–Ω–∏—á–µ–Ω:</b> {restricted}\n"
               f"<b>–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω:</b> {verified}\n\n"
               f"<b>–û —Å–µ–±–µ:</b> \n<code>{user_bio}</code>\n\n"
               f"<b>–ö–æ–ª-–≤–æ –∞–≤–∞—Ç–∞—Ä–æ–∫ –≤ –ø—Ä–æ—Ñ–∏–ª–µ:</b> {user_photos_count}\n"
               f"<b>–û–±—â–∏–µ —á–∞—Ç—ã:</b> {common_chat}\n"
               f"<b>–ü–µ—Ä–º–∞–ª–∏–Ω–∫:</b> <a href=\"tg://user?id={user_id}\">–∫–ª–∏–∫</a>\n"
               f"<b>Premium Stickers:</b> {premium_stickers}")

    return photo, caption
